name: Security Scan

on:
  schedule:
    - cron: '0 2 * * 1'  # Tous les lundis à 2h du matin
  push:
    branches:
      - main
      - production
  workflow_dispatch:

jobs:
  # Scan des vulnérabilités de dépendances
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        app: [admin, store, website]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install dependencies
        working-directory: ${{ matrix.app == 'admin' && 'Admin Panel' || matrix.app == 'store' && 'Store Panel' || 'Website Panel' }}
        run: composer install --prefer-dist

      - name: Check for security vulnerabilities
        working-directory: ${{ matrix.app == 'admin' && 'Admin Panel' || matrix.app == 'store' && 'Store Panel' || 'Website Panel' }}
        run: composer audit

  # Scan des images Docker
  docker-scan:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        app: [admin, store, website, landing]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.app == 'admin' && 'Admin Panel' || matrix.app == 'store' && 'Store Panel' || matrix.app == 'website' && 'Website Panel' || 'Landing Panel' }}
          file: ./${{ matrix.app == 'admin' && 'Admin Panel' || matrix.app == 'store' && 'Store Panel' || matrix.app == 'website' && 'Website Panel' || 'Landing Panel' }}/Dockerfile
          push: false
          load: true
          tags: fikaso-${{ matrix.app }}:scan

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: fikaso-${{ matrix.app }}:scan
          format: 'sarif'
          output: 'trivy-results-${{ matrix.app }}.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results-${{ matrix.app }}.sarif'

  # Code quality et sécurité
  code-quality:
    name: Code Quality & Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

