version: '3.8'

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: fikaso_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
      MYSQL_DATABASE: fikaso_admin_db
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/init-databases.sql:/docker-entrypoint-initdb.d/00_init_databases.sql
      #- ./emart_admin_database.sql:/docker-entrypoint-initdb.d/01_admin.sql
      #- ./emart_store_database.sql:/docker-entrypoint-initdb.d/02_store.sql
      #- ./emart_website_database.sql:/docker-entrypoint-initdb.d/03_website.sql
    ports:
      - "3306:3306"
    networks:
      - fikaso_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Admin Panel
  admin:
    build:
      context: ./Admin Panel
      dockerfile: Dockerfile
    container_name: fikaso_admin
    restart: unless-stopped
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: fikaso_admin_db
      DB_USERNAME: root
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
      APP_ENV: production
      APP_DEBUG: false
      APP_KEY: ${ADMIN_APP_KEY}
      APP_URL: ${ADMIN_URL:-https://admin.example.com}

      BROADCAST_DRIVER: log
      CACHE_DRIVER: file
      FILESYSTEM_DRIVER: local
      QUEUE_CONNECTION: sync
      SESSION_DRIVER: file
      SESSION_LIFETIME: 120

      FIREBASE_APIKEY: ${FIREBASE_APIKEY}
      FIREBASE_AUTH_DOMAIN: ${FIREBASE_AUTH_DOMAIN}
      FIREBASE_DATABASE_URL: ${FIREBASE_DATABASE_URL}
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
      FIREBASE_STORAGE_BUCKET: ${FIREBASE_STORAGE_BUCKET}
      FIREBASE_MESSAAGING_SENDER_ID: ${FIREBASE_MESSAAGING_SENDER_ID}
      FIREBASE_APP_ID: ${ADMIN_FIREBASE_APP_ID}
      FIREBASE_MEASUREMENT_ID: ${ADMIN_FIREBASE_MEASUREMENT_ID}

      IS_DISABLE_CHANGE_IMAGE: ${IS_DISABLE_CHANGE_IMAGE}
      LOCALE: ${LOCALE}
      FALLBACK_LOCALE: ${FALLBACK_LOCALE}

      APP_TIMEZONE: ${APP_TIMEZONE}
      NODE_PATH: ${NODE_PATH}

    volumes:
      - ./Admin Panel:/var/www/html
      - admin_storage:/var/www/html/storage
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - fikaso_network

  # Store Panel
  store:
    build:
      context: ./Store Panel
      dockerfile: Dockerfile
    container_name: fikaso_store
    restart: unless-stopped
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: fikaso_store_db
      DB_USERNAME: root
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
      APP_ENV: production
      APP_DEBUG: false
      APP_KEY: ${STORE_APP_KEY}
      APP_URL: ${STORE_URL:-https://store.example.com}

      BROADCAST_DRIVER: log
      CACHE_DRIVER: file
      FILESYSTEM_DRIVER: local
      QUEUE_CONNECTION: sync
      SESSION_DRIVER: file
      SESSION_LIFETIME: 120

      FIREBASE_APIKEY: ${FIREBASE_APIKEY}
      FIREBASE_AUTH_DOMAIN: ${FIREBASE_AUTH_DOMAIN}
      FIREBASE_DATABASE_URL: ${FIREBASE_DATABASE_URL}
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
      FIREBASE_STORAGE_BUCKET: ${FIREBASE_STORAGE_BUCKET}
      FIREBASE_MESSAAGING_SENDER_ID: ${FIREBASE_MESSAAGING_SENDER_ID}
      FIREBASE_APP_ID: ${STORE_FIREBASE_APP_ID}
      FIREBASE_MEASUREMENT_ID: ${STORE_FIREBASE_MEASUREMENT_ID}

      LOCALE: ${LOCALE}
      FALLBACK_LOCALE: ${FALLBACK_LOCALE}

    volumes:
      - ./Store Panel:/var/www/html
      - store_storage:/var/www/html/storage
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - fikaso_network

  # Website Panel
  website:
    build:
      context: ./Website Panel
      dockerfile: Dockerfile
    container_name: fikaso_website
    restart: unless-stopped
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: fikaso_website_db
      DB_USERNAME: root
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
      APP_ENV: production
      APP_DEBUG: false
      APP_KEY: ${WEBSITE_APP_KEY}
      APP_URL: ${WEBSITE_URL:-https://shop.example.com}

      BROADCAST_DRIVER: log
      CACHE_DRIVER: file
      FILESYSTEM_DRIVER: local
      QUEUE_CONNECTION: sync
      SESSION_DRIVER: file
      SESSION_LIFETIME: 120

      FIREBASE_APIKEY: ${FIREBASE_APIKEY}
      FIREBASE_AUTH_DOMAIN: ${FIREBASE_AUTH_DOMAIN}
      FIREBASE_DATABASE_URL: ${FIREBASE_DATABASE_URL}
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
      FIREBASE_STORAGE_BUCKET: ${FIREBASE_STORAGE_BUCKET}
      FIREBASE_MESSAAGING_SENDER_ID: ${FIREBASE_MESSAAGING_SENDER_ID}
      FIREBASE_APP_ID: ${WEB_FIREBASE_APP_ID}
      FIREBASE_MEASUREMENT_ID: ${WEB_FIREBASE_MEASUREMENT_ID}

      LOCALE: ${LOCALE}
      FALLBACK_LOCALE: ${FALLBACK_LOCALE}
    volumes:
      - ./Website Panel:/var/www/html
      - website_storage:/var/www/html/storage
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - fikaso_network

  # Landing Panel
  landing:
    build:
      context: ./Landing Panel
      dockerfile: Dockerfile
    container_name: fikaso_landing
    restart: unless-stopped
    volumes:
      - ./Landing Panel:/usr/share/nginx/html:ro
    networks:
      - fikaso_network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: fikaso_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - admin
      - store
      - website
      - landing
    networks:
      - fikaso_network

networks:
  fikaso_network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  admin_storage:
    driver: local
  store_storage:
    driver: local
  website_storage:
    driver: local
  nginx_logs:
    driver: local

